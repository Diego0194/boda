<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirma asistencia â€” F&D</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="media/favicon.png">
</head>

<body>
<header>
  <div class="container header-flex">
    <div class="brand">
      <a href="index.html" style="text-decoration:none;color:inherit;"><h1>F&D</h1></a>
      <p class="lead">5 de septiembre de 2026 â€” Espinosa de los Monteros, Burgos</p>
    </div>
    <button class="menu-toggle" aria-label="Abrir menÃº">â˜°</button>
  </div>

  <nav class="nav-links">
    <a href="index.html">ğŸ‘‹ Bienvenidos</a>
    <a href="nosotros.html">â¤ï¸ Nosotros</a>
    <a href="programa.html">ğŸ“† Programa</a>
    <a href="asistencia.html" class="active">âœ… Confirma asistencia</a>
    <a href="direccion.html">ğŸŒ DirecciÃ³n</a>
    <a href="informacion.html">ğŸ“Œ InformaciÃ³n Ãºtil</a>
    <a href="regalos.html">ğŸ Lista de regalos</a>
    <a href="fotos.html">ğŸ“· Fotos de la boda</a>
    <a href="foro.html">ğŸ’¬ Foro</a>
  </nav>
</header>

<main class="page-wrapper">
  <div class="page-container">

    <h2>Confirma tu asistencia</h2>
    <div class="intro">Introduce tu nombre y apellido para confirmar tu asistencia</div>

    <input id="nombre" placeholder="Nombre y Apellido">
    <button id="buscar">Buscar</button>

    <p id="mensajeError" class="hidden"></p>

    <div id="resultado" class="hidden">
      <p id="mensajeGrupo" class="hidden">Â¿Quieres confirmar algÃºn otro invitado?</p>

      <!-- Formulario clÃ¡sico para evitar CORS -->
      <form id="alergenosForm" class="hidden" method="POST" action="https://script.google.com/macros/s/AKfycbwi_vlMjbCPRsaVGWAUyXHjLy4THbLwX0uXDc5761yR01asrrizha_Ow_Mq8NE2-G3K/exec">
        <div id="listaInvitados"></div>
        <input type="hidden" name="confirmadosJSON" id="confirmadosJSON">
        <button type="submit" id="enviar" class="hidden">Confirmar asistencia</button>
      </form>
    </div>

    <div id="mensajeFinal" class="hidden"></div>

  </div>
</main>

<footer>
  <div class="container">
    <p>Creado con cariÃ±o â€” FÃ¡tima & Diego â€¢ 5 Septiembre 2026<br>
       Contacto: 656573103 (Diego), 670935370 (FÃ¡tima).
    </p>
  </div>
</footer>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbwi_vlMjbCPRsaVGWAUyXHjLy4THbLwX0uXDc5761yR01asrrizha_Ow_Mq8NE2-G3K/exec";
let invitados = [];

async function cargarInvitados() {
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    invitados = data.map(i => ({...i, _norm: i.nombre.toLowerCase().trim() + ' ' + i.apellido.toLowerCase().trim()}));
  } catch(e){ mostrarError("No se pudo cargar la lista de invitados."); }
}

const nombreInput = document.getElementById("nombre");
const buscarBtn = document.getElementById("buscar");
const mensajeError = document.getElementById("mensajeError");
const resultado = document.getElementById("resultado");
const mensajeGrupo = document.getElementById("mensajeGrupo");
const lista = document.getElementById("listaInvitados");
const form = document.getElementById("alergenosForm");
const enviarBtn = document.getElementById("enviar");
const mensajeFinal = document.getElementById("mensajeFinal");

buscarBtn.addEventListener("click", ()=>{
  resetUI();
  const texto = nombreInput.value.toLowerCase().trim();
  const invitado = invitados.find(i => i._norm === texto);
  if(!invitado){ mostrarError("Lo sentimos, tu nombre no estÃ¡ en la lista de invitados."); return; }

  resultado.classList.remove("hidden");
  form.classList.remove("hidden");

  let miembros=[invitado];
  if(invitado.grupo){
    miembros = invitados.filter(i => i.grupo === invitado.grupo && !i.confirmado);
    if(!miembros.length){ mostrarError("Todos los miembros de tu grupo ya han confirmado."); return; }
    mensajeGrupo.classList.remove("hidden");
  }

  miembros.forEach(i => pintarFila(i, true));
  enviarBtn.classList.remove("hidden");
});

form.addEventListener("submit", async e => {
  e.preventDefault(); // evita la navegaciÃ³n
  const filas = document.querySelectorAll(".inv-row");
  const confirmados = [];

  filas.forEach(fila => {
    const checkbox = fila.querySelector("input[type='checkbox']");
    if(!checkbox.checked) return;
    const nombreApellido = fila.querySelector("span").textContent;
    const [nombre, ...resto] = nombreApellido.split(" ");
    const apellido = resto.join(" ");
    const alergenos = fila.querySelector("input[type='text']").value;
    confirmados.push({ nombre, apellido, alergenos });
  });

  if(!confirmados.length){ mostrarError("Debes seleccionar al menos un invitado."); return; }

  try{
    await fetch(WEB_APP_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ confirmados })
    });
    form.classList.add("hidden");
    mensajeFinal.textContent = "Â¡Gracias por confirmar tu asistencia!";
    mensajeFinal.classList.remove("hidden");
  } catch(err){
    mostrarError("Error al enviar la confirmaciÃ³n.");
  }
});

function pintarFila(inv, auto){
  const div = document.createElement("div");
  div.className = "inv-row";
  const cb = document.createElement("input"); cb.type="checkbox"; cb.checked = auto;
  const span = document.createElement("span"); span.textContent = `${inv.nombre} ${inv.apellido}`;
  const alerg = document.createElement("input"); alerg.type="text"; alerg.placeholder="AlÃ©rgenos"; alerg.classList.toggle("hidden", !auto);
  cb.addEventListener("change", ()=>alerg.classList.toggle("hidden", !cb.checked));
  div.appendChild(cb); div.appendChild(span); div.appendChild(alerg);
  lista.appendChild(div);
}

function resetUI(){
  mensajeError.classList.add("hidden");
  resultado.classList.add("hidden");
  form.classList.add("hidden");
  lista.innerHTML="";
  enviarBtn.classList.add("hidden");
  mensajeFinal.classList.add("hidden");
  mensajeGrupo.classList.add("hidden");
}

function mostrarError(msg){ mensajeError.textContent = msg; mensajeError.classList.remove("hidden"); }

document.addEventListener("DOMContentLoaded", cargarInvitados);

// MenÃº mÃ³vil
const menuToggle = document.querySelector(".menu-toggle");
const navLinks = document.querySelector(".nav-links");
menuToggle.addEventListener("click", ()=>navLinks.classList.toggle("open"));
</script>

</body>
</html>