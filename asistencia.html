<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirma asistencia ‚Äî F&D</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="media/favicon.png">
</head>
<style>
.inv-row {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 12px;
  margin-bottom: 14px;
}

.inv-row span {
  flex: 1 1 180px;
  font-weight: 500;
}

.inv-row select.asistencia {
  flex: 0 0 50px;
  padding: 6px;
}

.inv-row input.alergenos {
  visibility: hidden;
  opacity: 0;
  transition: opacity 0.3s ease;
  flex: 2 1 220px;
  padding: 6px;
}
.inv-row input.alergenos.visible {
  visibility: visible;
  opacity: 1;
}

#enviar:disabled {
  background-color: #ccc;
  color: #666;
  cursor: not-allowed;
  border: none;
}

.page-wrapper {
  padding-bottom: 50px;
}

#btnEnviarCorreo {
  background-color: #b74d4d;
  color: white;
  border-radius: 10px;
  border: none;
  padding: 0 20px;
  font-family: 'Playfair Display', serif;
  cursor: pointer;
}

#btnEnviarCorreo:hover {
  background: #9c3f3f;
}
/* Estilo id√©ntico a al√©rgenos pero siempre visible */
.email-clon-alergenos {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
  flex: 2 1 220px;
  padding: 10px;
  border: 2px solid #ddd; /* El mismo borde que usas en .inv-row input */
  border-radius: 10px;    /* Redondeado exacto de tu imagen */
  font-family: 'Playfair Display', serif;
  outline: none;
  background-color: white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.email-clon-alergenos:focus {
  border-color: #b74d4d;
}

#mensajeFinal {
  white-space: pre-line; /* Esto hace que los \n se conviertan en saltos de l√≠nea reales */
  color: #555;
  font-weight: 600;
  margin-top: 20px;
  line-height: 1.5;
}
</style>
<body>
<header>
  <div class="container header-flex">
    <div class="brand">
      <a href="index.html" style="text-decoration:none;color:inherit;"><h1>F&D</h1></a>
      <p class="lead">5 de septiembre de 2026 ‚Äî Espinosa de los Monteros, Burgos</p>
    </div>
    <button class="menu-toggle" aria-label="Abrir men√∫">‚ò∞</button>
  </div>

  <nav class="nav-links">
    <a href="index.html">üëã Bienvenidos</a>
    <a href="nosotros.html">‚ù§Ô∏è Nosotros</a>
    <a href="programa.html">üìÜ Programa</a>
    <a href="asistencia.html" class="active">‚úÖ Confirma asistencia</a>
    <a href="direccion.html">üåç Direcci√≥n</a>
    <a href="informacion.html">üìå Informaci√≥n √∫til</a>
    <a href="regalos.html">üéÅ Lista de regalos</a>
    <a href="fotos.html">üì∑ Fotos de la boda</a>
    <a href="foro.html">üí¨ Foro</a>
  </nav>
</header>

<main class="page-wrapper">
  <div class="page-container" style="margin-bottom: 100px;">

    <h2>Confirma tu asistencia</h2>
    <div class="intro">Introduce tu nombre y apellido para confirmar tu asistencia</div>

    <input id="nombre" placeholder="Nombre y Apellido">
    <ul id="autocomplete" class="hidden"></ul>

    <!-- Bot√≥n oculto (Opci√≥n A) -->
    <button id="buscar" style="display:none;">Buscar</button>

    <p id="mensajeError" class="hidden"></p>

    <div id="resultado" class="hidden">
      <p id="mensajeGrupo" class="hidden"></p>
      <form id="alergenosForm" class="hidden">
        <div id="listaInvitados"></div>
        <button type="submit" id="enviar" class="hidden"></button>
      </form>
    </div>

    <div id="mensajeFinal" class="hidden"></div>

    <!-- BOTONES DE CALENDARIO -->
<div id="seccionCorreo" class="hidden" style="margin-top: 40px; border-top: 1px solid #eee; padding-top: 30px;">
  <p style="margin-bottom: 20px; font-family: 'Playfair Display', serif; font-size: 1.1rem; text-align: center;">
    Si quieres recibir el recordatorio en tu email, escr√≠belo aqu√≠:
  </p>
  
  <div id="listaCorreo">
    <div class="inv-row" style="justify-content: center; align-items: center;">
      <span style="flex: 0 0 auto; margin-right: 10px;">Tu Email:</span>
      <input type="text" id="emailUsuario" placeholder="ejemplo@correo.com" class="email-clon-alergenos">
      <button id="btnEnviarCorreo" class="btn" style="margin-left: 15px; height: 45px;">Enviar</button>
    </div>
  </div>
  
  <p id="msgCorreo" style="margin-top:15px; font-size: 0.9rem; font-weight:600; text-align: center;"></p>
</div>
  
  <p id="msgCorreo" style="margin-top:15px; font-size: 0.9rem; font-weight:600;"></p>
</div>
	
  </div>
</main>

<footer>
  <div class="container">
    <p>Creado con cari√±o ‚Äî F√°tima & Diego ‚Ä¢ 5 Septiembre 2026<br>
       Contacto: 656573103 (Diego), 670935370 (F√°tima).
    </p>
  </div>
</footer>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzZBdCiO48E9NQzPcybO_Ca4Ulhdvc5XKaD8dSgsztw_P2-cYbWBbdiG6_e3zDurHuI/exec";
let invitados = [];

async function cargarInvitados() {
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    invitados = data.map(i => ({
      ...i,
      _norm: normalizarTexto(i.nombre + ' ' + i.apellido)
    }));
  } catch(e){
    mostrarError("No se pudo cargar la lista de invitados.");
  }
}

const autocomplete = document.getElementById("autocomplete");
const nombreInput = document.getElementById("nombre");
const buscarBtn = document.getElementById("buscar");

// AUTOCOMPLETADO
nombreInput.addEventListener("input", () => {
  const texto = normalizarTexto(nombreInput.value);

  autocomplete.innerHTML = "";

  if (!texto) {
    autocomplete.classList.add("hidden");
    return;
  }

  const sugerencias = invitados.filter(i => i._norm.includes(texto));

  if (!sugerencias.length) {
    autocomplete.classList.add("hidden");
    return;
  }

  sugerencias.slice(0, 5).forEach(inv => {
    const li = document.createElement("li");
    li.textContent = `${inv.nombre} ${inv.apellido}`;

    li.addEventListener("click", () => {
      nombreInput.value = li.textContent;
      autocomplete.classList.add("hidden");
      buscarBtn.click();
    });

    autocomplete.appendChild(li);
  });

  autocomplete.classList.remove("hidden");
});

// Ocultar sugerencias al hacer clic fuera
document.addEventListener("click", (e) => {
  if (!autocomplete.contains(e.target) && e.target !== nombreInput) {
    autocomplete.classList.add("hidden");
  }
});

const mensajeError = document.getElementById("mensajeError");
const resultado = document.getElementById("resultado");
const mensajeGrupo = document.getElementById("mensajeGrupo");
const lista = document.getElementById("listaInvitados");
const form = document.getElementById("alergenosForm");
const enviarBtn = document.getElementById("enviar");
const mensajeFinal = document.getElementById("mensajeFinal");

buscarBtn.addEventListener("click", () => {
  resetUI();
  const texto = normalizarTexto(nombreInput.value);
  const invitado = invitados.find(i => i._norm === texto);

  if (!invitado) {
    mostrarError("Lo sentimos, tu nombre no est√° en la lista de invitados.");
    return;
  }

  resultado.classList.remove("hidden");
  form.classList.remove("hidden");
  nombreInput.classList.add("hidden");

  // CASO: INVITADO INDIVIDUAL
  if (!invitado.grupo) {
    if (invitado.confirmado === "SI" || invitado.confirmado === "NO") {
      document.querySelector(".intro").textContent = "";
      mostrarError("Ya hemos recibido tu respuesta. Si necesitas hacer cambios ponte en contacto con los novios.");
      pintarFilaConfirmado(invitado);
      
      // CAMBIO: Si ya confirm√≥ que SI, mostramos el correo directamente
      if (invitado.confirmado === "SI") mostrarSeccionCorreo(); 
      return;
    }
    document.querySelector(".intro").textContent = "Introduce al√©rgenos y selecciona Enviar para confirmar tu asistencia";
    pintarFila(invitado, false);
  } 
  // CASO: INVITADO EN GRUPO
  else {
    const grupoCompleto = invitados.filter(i => i.grupo === invitado.grupo);
    const miembrosPendientes = grupoCompleto.filter(i => i.confirmado === "" || i.confirmado === null);

    // Si TODO el grupo ha confirmado ya
    if (miembrosPendientes.length === 0) {
      document.querySelector(".intro").textContent = "";
      mostrarError("Todos los miembros de tu grupo ya han confirmado.");
      grupoCompleto.forEach(miembro => pintarFilaConfirmado(miembro));
      
      // CAMBIO: Si alguien del grupo confirm√≥ que SI, mostramos el correo
      if (grupoCompleto.some(m => m.confirmado === "SI")) mostrarSeccionCorreo();
      return;
    }

    // Si hay gente pendiente en el grupo
    document.querySelector(".intro").textContent = "Introduce al√©rgenos y selecciona Enviar para confirmar tu asistencia";
    mensajeGrupo.textContent = "¬øQuieres confirmar s√≥lo tu asistencia o la de alguien m√°s de tu grupo?";
    mensajeGrupo.classList.remove("hidden");

    miembrosPendientes.forEach(i => {
      const esBuscado = (i._norm === invitado._norm);
      pintarFila(i, true, esBuscado);
    });

    const yaConfirmados = grupoCompleto.filter(i => i.confirmado);
    yaConfirmados.forEach(miembro => pintarFilaConfirmado(miembro));

    // CAMBIO: Si ya hay alguien confirmado como "SI" en el grupo aunque falten otros
    if (yaConfirmados.some(m => m.confirmado === "SI")) mostrarSeccionCorreo();
  }

  enviarBtn.textContent = "Confirmar asistencia";
  enviarBtn.classList.remove("hidden");
});

form.addEventListener("submit", async (e) => {
  e.preventDefault();

  // Solo buscamos las filas que est√°n dentro de la lista de invitados para no confundir con el email
  const listaInvitados = document.getElementById("listaInvitados");
  const filas = listaInvitados.querySelectorAll(".inv-row");
  
  const datosParaEnviar = [];
  let nombresConfirmados = [];
  let nombresNoAsistiran = [];

  filas.forEach(fila => {
    const nombreCompleto = fila.querySelector("span").textContent.trim();
    const asistencia = fila.querySelector(".asistencia").value;
    const alergenos = fila.querySelector(".alergenos").value.trim();

    if (asistencia === "") return;

    // Guardamos los datos para el env√≠o al servidor
    const partes = nombreCompleto.split(" ");
    datosParaEnviar.push({ 
      nombre: partes[0], 
      apellido: partes.slice(1).join(" "), 
      asistencia, 
      alergenos 
    });

    // Clasificamos para el mensaje de √©xito local
    if (asistencia === "SI") {
      nombresConfirmados.push(nombreCompleto);
    } else {
      nombresNoAsistiran.push(nombreCompleto);
    }
  });

  if (!datosParaEnviar.length) {
    mostrarError("Debes seleccionar al menos un invitado.");
    return;
  }

  enviarBtn.disabled = true;
  enviarBtn.textContent = "Enviando...";

  try {
    const formData = new FormData();
    formData.append("confirmados", JSON.stringify(datosParaEnviar));

    const response = await fetch(WEB_APP_URL, {
      method: "POST",
      body: formData
    });

    if (!response.ok) throw new Error("Error en el servidor");

    // Ocultamos elementos del formulario
    form.classList.add("hidden");
    const intro = document.querySelector(".intro");
    if (intro) intro.classList.add("hidden");
    mensajeError.classList.add("hidden");
    mensajeGrupo.classList.add("hidden");
    resultado.classList.add("hidden");

    // CONSTRUCCI√ìN DEL MENSAJE DIN√ÅMICO
    let textoResumen = "¬°Gracias por confirmar tu asistencia!";
    
    if (nombresConfirmados.length > 0 || nombresNoAsistiran.length > 0) {
      textoResumen += "\n\nSe ha actualizado el estado de:";
      if (nombresConfirmados.length > 0) {
        textoResumen += "\n‚úÖ Confirmados: " + nombresConfirmados.join(", ");
      }
      if (nombresNoAsistiran.length > 0) {
        textoResumen += "\n‚ùå No asistir√°n: " + nombresNoAsistiran.join(", ");
      }
    }

    mensajeFinal.innerText = textoResumen; // Usamos innerText para los saltos de l√≠nea
    mensajeFinal.classList.remove("hidden");

    // Mostramos la secci√≥n para enviar el correo recordatorio
    mostrarSeccionCorreo(); 
    
    // Actualizamos la lista local desde la base de datos
    await cargarInvitados();

  } catch (err) {
    mostrarError("Error al enviar la confirmaci√≥n. Por favor, int√©ntalo de nuevo.");
    enviarBtn.disabled = false;
    enviarBtn.textContent = "Confirmar asistencia";
  }
});

function normalizarTexto(txt) {
  return txt
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .trim();
}

function pintarFila(inv, esGrupo, esBuscado = false) {
  const div = document.createElement("div");
  div.className = "inv-row";

  const span = document.createElement("span");
  span.textContent = `${inv.nombre} ${inv.apellido}`;
  div.appendChild(span);

  const select = document.createElement("select");
  select.className = "asistencia";
  select.innerHTML = `<option value="">-</option><option value="SI">S√≠</option><option value="NO">No</option>`;
  div.appendChild(select);

  const alerg = document.createElement("input");
  alerg.type = "text";
  alerg.placeholder = "Al√©rgenos";
  alerg.className = "alergenos";

  select.addEventListener("change", () => {
    alerg.classList.toggle("visible", select.value === "SI");
    if (select.value !== "SI") alerg.value = "";
    actualizarEstadoBoton();
  });

  div.appendChild(alerg);
  lista.appendChild(div);
}

function pintarFilaConfirmado(inv) {
  const div = document.createElement("div");
  div.className = "inv-confirmado";
  const asistira = inv.confirmado === "SI";
  const icono = asistira ? "‚úÖ Asistir√©" : "‚ùå No podr√© asistir";
  const alerg = (asistira && inv.alergenos) ? ` ‚Äî Al√©rgenos: ${inv.alergenos}` : "";
  div.innerHTML = `<strong>${inv.nombre} ${inv.apellido}</strong> ‚Äî ${icono}${alerg}`;
  lista.appendChild(div);
}

function resetUI() {
  mensajeError.classList.add("hidden");
  resultado.classList.add("hidden");
  form.classList.add("hidden");
  lista.innerHTML = "";
  enviarBtn.classList.add("hidden");
  mensajeFinal.classList.add("hidden");
  mensajeGrupo.classList.add("hidden");
  // Eliminamos la l√≠nea de 'calendars' porque ya no existe ese ID
  document.getElementById("seccionCorreo").classList.add("hidden"); 
}

function actualizarEstadoBoton() {
  const selects = document.querySelectorAll(".inv-row select.asistencia");
  const algunoSeleccionado = Array.from(selects).some(sel => sel.value !== "");
  enviarBtn.disabled = !algunoSeleccionado;
}

function mostrarError(msg) {
  mensajeError.textContent = msg;
  mensajeError.classList.remove("hidden");
}

document.addEventListener("DOMContentLoaded", () => {
  cargarInvitados();
  resetUI();
});

const menuToggle = document.querySelector(".menu-toggle");
const navLinks = document.querySelector(".nav-links");
menuToggle.addEventListener("click", () => navLinks.classList.toggle("open"));

// Manejo del bot√≥n de enviar correo
const btnCorreo = document.getElementById("btnEnviarCorreo");
btnCorreo.addEventListener("click", async () => {
  const email = document.getElementById("emailUsuario").value;
  const msgCorreo = document.getElementById("msgCorreo");

  if (!email || !email.includes("@")) {
    msgCorreo.textContent = "Por favor, introduce un correo v√°lido.";
    return;
  }

  btnCorreo.disabled = true;
  btnCorreo.textContent = "Enviando...";

  try {
    const formData = new FormData();
    formData.append("accion", "enviarEmailConCalendario");
    formData.append("destinatario", email);

    // Reutilizamos tu URL de Google Apps Script
    await fetch(WEB_APP_URL, { method: "POST", body: formData });

    msgCorreo.style.color = "green";
    msgCorreo.textContent = "¬°Correo enviado con √©xito!";
    btnCorreo.classList.add("hidden");
  } catch (e) {
    msgCorreo.textContent = "Error al enviar el correo.";
    btnCorreo.disabled = false;
  }
});

// Funci√≥n para mostrar la secci√≥n de correo (ll√°mala en vez de mostrarBotonesCalendario)
function mostrarSeccionCorreo() {
  document.getElementById("seccionCorreo").classList.remove("hidden");
}

</script>

</body>
</html>
