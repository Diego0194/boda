<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Confirma asistencia â€” F&D</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <link rel="icon" type="image/png" href="media/favicon.png">
</head>

<body>
<header>
  <div class="container header-flex">
    <div class="brand">
      <a href="index.html" style="text-decoration:none;color:inherit;"><h1>F&D</h1></a>
      <p class="lead">5 de septiembre de 2026 â€” Espinosa de los Monteros, Burgos</p>
    </div>
    <button class="menu-toggle" aria-label="Abrir menÃº">â˜°</button>
  </div>

  <nav class="nav-links">
    <a href="index.html">ğŸ‘‹ Bienvenidos</a>
    <a href="nosotros.html">â¤ï¸ Nosotros</a>
    <a href="programa.html">ğŸ“† Programa</a>
    <a href="asistencia.html" class="active">âœ… Confirma asistencia</a>
    <a href="direccion.html">ğŸŒ DirecciÃ³n</a>
    <a href="informacion.html">ğŸ“Œ InformaciÃ³n Ãºtil</a>
    <a href="regalos.html">ğŸ Lista de regalos</a>
    <a href="fotos.html">ğŸ“· Fotos de la boda</a>
    <a href="foro.html">ğŸ’¬ Foro</a>
  </nav>
</header>

<main class="page-wrapper">
  <div class="page-container" style="margin-bottom: 100px;">

    <h2>Confirma tu asistencia</h2>
    <div class="intro">Introduce tu nombre y apellido para confirmar tu asistencia</div>

    <input id="nombre" placeholder="Nombre y Apellido">
    <ul id="autocomplete" class="hidden"></ul>

    <!-- BotÃ³n oculto (OpciÃ³n A) -->
    <button id="buscar" style="display:none;">Buscar</button>

    <p id="mensajeError" class="hidden"></p>

    <div id="resultado" class="hidden">
      <p id="mensajeGrupo" class="hidden"></p>
      <form id="alergenosForm" class="hidden">
        <div id="listaInvitados"></div>
        <button type="submit" id="enviar" class="hidden"></button>
      </form>
    </div>

    <div id="mensajeFinal" class="hidden"></div>

    <!-- BOTONES DE CALENDARIO -->
    <div id="calendars" class="hidden" style="margin-top: 25px;">
      <a id="appleLink" target="_blank">
        <img src="media/AppleCalendar.png" alt="AÃ±adir a Apple Calendar" style="height: 55px; margin-right: 12px;">
      </a>
      <a id="googleLink" target="_blank">
        <img src="media/GoogleCalendar.png" alt="AÃ±adir a Google Calendar" style="height: 55px;">
      </a>
    </div>

  </div>
</main>

<footer>
  <div class="container">
    <p>Creado con cariÃ±o â€” FÃ¡tima & Diego â€¢ 5 Septiembre 2026<br>
       Contacto: 656573103 (Diego), 670935370 (FÃ¡tima).
    </p>
  </div>
</footer>

<script>
const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzsUr07-2wDoqXpys8Z4cUHk2ueC7f706UIKZkksUlxhKagm5-iXJXIeU7NyYWwNTKI/exec";
let invitados = [];

async function cargarInvitados() {
  try {
    const res = await fetch(WEB_APP_URL);
    const data = await res.json();
    invitados = data.map(i => ({
      ...i,
      _norm: i.nombre.toLowerCase().trim() + ' ' + i.apellido.toLowerCase().trim()
    }));
  } catch(e){
    mostrarError("No se pudo cargar la lista de invitados.");
  }
}

const autocomplete = document.getElementById("autocomplete");
const nombreInput = document.getElementById("nombre");
const buscarBtn = document.getElementById("buscar");

// AUTOCOMPLETADO
nombreInput.addEventListener("input", () => {
  const texto = nombreInput.value.toLowerCase().trim();
  autocomplete.innerHTML = "";

  if (!texto) {
    autocomplete.classList.add("hidden");
    return;
  }

  const sugerencias = invitados.filter(i => i._norm.includes(texto));

  if (!sugerencias.length) {
    autocomplete.classList.add("hidden");
    return;
  }

  sugerencias.slice(0, 5).forEach(inv => {
    const li = document.createElement("li");
    li.textContent = `${inv.nombre} ${inv.apellido}`;

    li.addEventListener("click", () => {
      nombreInput.value = li.textContent;
      autocomplete.classList.add("hidden");
      buscarBtn.click(); // â† ejecuta la lÃ³gica original
    });

    autocomplete.appendChild(li);
  });

  autocomplete.classList.remove("hidden");
});

// Ocultar sugerencias al hacer clic fuera
document.addEventListener("click", (e) => {
  if (!autocomplete.contains(e.target) && e.target !== nombreInput) {
    autocomplete.classList.add("hidden");
  }
});

const mensajeError = document.getElementById("mensajeError");
const resultado = document.getElementById("resultado");
const mensajeGrupo = document.getElementById("mensajeGrupo");
const lista = document.getElementById("listaInvitados");
const form = document.getElementById("alergenosForm");
const enviarBtn = document.getElementById("enviar");
const mensajeFinal = document.getElementById("mensajeFinal");

buscarBtn.addEventListener("click", () => {
  resetUI();
  const texto = nombreInput.value.toLowerCase().trim();
  const invitado = invitados.find(i => i._norm === texto);

  if (!invitado) {
    mostrarError("Lo sentimos, tu nombre no estÃ¡ en la lista de invitados.");
    return;
  }

resultado.classList.remove("hidden");
form.classList.remove("hidden");
nombreInput.classList.add("hidden");

// Mostrar el texto SOLO si el invitado NO ha confirmado
if (!invitado.confirmado) {
  document.querySelector(".intro").textContent =
    "Introduce alÃ©rgenos y selecciona Enviar para confirmar tu asistencia";
}


  let miembros = [];

if (!invitado.grupo) {

  // Si ya estÃ¡ confirmado â†’ mostrar mensaje y datos
  if (invitado.confirmado) {
	document.querySelector(".intro").textContent = ""; // â† OCULTAR INTRO
    mostrarError("Ya has confirmado tu asistencia anteriormente. Si necesitas hacer cambios ponte en contacto con los novios");

    resultado.classList.remove("hidden");
    form.classList.remove("hidden");

    // Mostrar su fila como confirmada
    pintarFilaConfirmado(invitado);
	
	// Mostrar botones calendario
	mostrarBotonesCalendario();
    return;
  }

  // Si NO estÃ¡ confirmado â†’ permitir confirmar
  miembros = [invitado];
  pintarFila(invitado, false);
} else {
    miembros = invitados.filter(i => i.grupo === invitado.grupo && !i.confirmado);

    if (!miembros.length) {
	  document.querySelector(".intro").textContent = ""; // â† OCULTAR INTRO
      mostrarError("Todos los miembros de tu grupo ya han confirmado, si necesitas hacer algÃºn cambio ponte en contacto con los novios.");

      resultado.classList.remove("hidden");
      form.classList.remove("hidden");

      const grupoCompleto = invitados.filter(i => i.grupo === invitado.grupo);
      grupoCompleto.forEach(miembro => pintarFilaConfirmado(miembro));
	  
	  // Mostrar botones calendario
	  mostrarBotonesCalendario();
      return;
    }

    mensajeGrupo.textContent =
      "Â¿Quieres confirmar sÃ³lo tu asistencia o la de alguien mÃ¡s de tu grupo?";
    mensajeGrupo.classList.remove("hidden");

    miembros.forEach(i => {
      const esBuscado = (i._norm === invitado._norm);
      pintarFila(i, true, esBuscado);
    });
  }

  enviarBtn.textContent = "Confirmar asistencia";
  enviarBtn.classList.remove("hidden");
});

form.addEventListener("submit", async e => {
  e.preventDefault();

  const filas = document.querySelectorAll(".inv-row");
  const confirmados = [];

  filas.forEach(fila => {
    const checkbox = fila.querySelector("input[type='checkbox']");
    const seleccionado = checkbox ? checkbox.checked : true;

    if (!seleccionado) return;

    const nombreApellido = fila.querySelector("span").textContent;
    const [nombre, ...resto] = nombreApellido.split(" ");
    const apellido = resto.join(" ");
    const alergenos = fila.querySelector("input[type='text']").value;

    confirmados.push({ nombre, apellido, alergenos });
  });

  if (!confirmados.length) {
    mostrarError("Debes seleccionar al menos un invitado.");
    return;
  }

  try {
    const formData = new FormData();
    formData.append("confirmados", JSON.stringify(confirmados));

    await fetch(WEB_APP_URL, {
      method: "POST",
      body: formData
    });

    form.classList.add("hidden");
    mensajeFinal.textContent = "Â¡Gracias por confirmar tu asistencia!";
    mensajeFinal.classList.remove("hidden");

    // MOSTRAR BOTONES DE CALENDARIO
    document.getElementById("calendars").classList.remove("hidden");

    // DATOS DEL EVENTO
    const titulo = "Boda FÃ¡tima & Diego";
    const fecha = "20260905"; // YYYYMMDD
    const ubicacion = "Torre de los Fernandez Villa, C. Progreso, 29, 09560 Espinosa de los Monteros, Burgos";
    const descripcion = "Gracias por acompaÃ±arnos a celebrar nuestro amor â¤ï¸";

    // APPLE CALENDAR (.ics)
    const icsContent = `
BEGIN:VCALENDAR
VERSION:2.0
CALSCALE:GREGORIAN
BEGIN:VEVENT
UID:boda-fatima-diego-20260905
DTSTAMP:20250101T120000Z
DTSTART:20260905T120000
DTEND:20260905T235900
SUMMARY:Boda FÃ¡tima & Diego
DESCRIPTION:Gracias por acompaÃ±arnos a celebrar nuestro amor â¤ï¸
LOCATION:Torre de los Fernandez Villa, C. Progreso, 29, 09560 Espinosa de los Monteros, Burgos
END:VEVENT
END:VCALENDAR
`.trim();

    const blob = new Blob([icsContent], { type: "text/calendar" });
    const appleUrl = URL.createObjectURL(blob);
    document.getElementById("appleLink").href = appleUrl;

    // GOOGLE CALENDAR
    const googleUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(titulo)}&dates=${fecha}/${fecha}&details=${encodeURIComponent(descripcion)}&location=${encodeURIComponent(ubicacion)}&sf=true&output=xml`;
    document.getElementById("googleLink").href = googleUrl;

  } catch(err){
    mostrarError("Error al enviar la confirmaciÃ³n.");
  }
});

function pintarFila(inv, esGrupo, esBuscado = false) {
  const div = document.createElement("div");
  div.className = "inv-row";

  let cb = null;
  if (esGrupo) {
    cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = esBuscado;
    div.appendChild(cb);
  }

  const span = document.createElement("span");
  span.textContent = `${inv.nombre} ${inv.apellido}`;
  div.appendChild(span);

  const alerg = document.createElement("input");
  alerg.type = "text";
  alerg.placeholder = "AlÃ©rgenos";

  if (esGrupo) {
    alerg.classList.toggle("hidden", !cb.checked);
    cb.addEventListener("change", () =>
      alerg.classList.toggle("hidden", !cb.checked)
    );
  }

  div.appendChild(alerg);
  lista.appendChild(div);
}

function pintarFilaConfirmado(inv) {
  const div = document.createElement("div");
  div.className = "inv-confirmado";
  div.textContent =
    `${inv.nombre} ${inv.apellido} â€” Confirmado â€” AlÃ©rgeno: ${inv.alergenos || "Ninguno"}`;
  lista.appendChild(div);
}

function resetUI() {
  mensajeError.classList.add("hidden");
  resultado.classList.add("hidden");
  form.classList.add("hidden");
  lista.innerHTML = "";
  enviarBtn.classList.add("hidden");
  mensajeFinal.classList.add("hidden");
  mensajeGrupo.classList.add("hidden");
  document.getElementById("calendars").classList.add("hidden");
}

function mostrarError(msg) {
  mensajeError.textContent = msg;
  mensajeError.classList.remove("hidden");
}

function mostrarBotonesCalendario() {
  const titulo = "Boda FÃ¡tima & Diego";
  const fecha = "20260905"; // YYYYMMDD
  const ubicacion = "Torre de los Fernandez Villa, C. Progreso, 29, 09560 Espinosa de los Monteros, Burgos";
  const descripcion = "Gracias por acompaÃ±arnos a celebrar nuestro amor â¤ï¸";

  // Apple Calendar (.ics)
  const icsContent = `
BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
DTSTART;VALUE=DATE:${fecha}
DTEND;VALUE=DATE:${fecha}
SUMMARY:${titulo}
DESCRIPTION:${descripcion}
LOCATION:${ubicacion}
END:VEVENT
END:VCALENDAR
`.trim();

  const blob = new Blob([icsContent], { type: "text/calendar" });
  const appleUrl = URL.createObjectURL(blob);
  document.getElementById("appleLink").href = appleUrl;

  // Google Calendar
  const googleUrl = `https://www.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(titulo)}&dates=${fecha}/${fecha}&details=${encodeURIComponent(descripcion)}&location=${encodeURIComponent(ubicacion)}&sf=true&output=xml`;
  document.getElementById("googleLink").href = googleUrl;

  document.getElementById("calendars").classList.remove("hidden");
}


document.addEventListener("DOMContentLoaded", () => {
  cargarInvitados();
  resetUI();
});

// MenÃº mÃ³vil
const menuToggle = document.querySelector(".menu-toggle");
const navLinks = document.querySelector(".nav-links");
menuToggle.addEventListener("click", () => navLinks.classList.toggle("open"));
</script>

</body>
</html>
